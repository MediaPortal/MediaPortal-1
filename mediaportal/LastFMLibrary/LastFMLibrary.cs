#region Copyright (C) 2005-2013 Team MediaPortal

// Copyright (C) 2005-2013 Team MediaPortal
// http://www.team-mediaportal.com
// 
// MediaPortal is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 2 of the License, or
// (at your option) any later version.
// 
// MediaPortal is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU General Public License for more details.
// 
// You should have received a copy of the GNU General Public License
// along with MediaPortal. If not, see <http://www.gnu.org/licenses/>.

#endregion

using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Net;
using System.Text;
using MediaPortal.Database;
using MediaPortal.Music.Database;
using MediaPortal.Profile;
using MediaPortal.GUI.Library;
using System.Xml.Linq;

namespace MediaPortal.LastFM
{
  public class LastFMLibrary
  {

    private static string _theSK = String.Empty;
    internal static string BaseURL = "http://ws.audioscrobbler.com/2.0/";

    #region ctor

    public LastFMLibrary()
    {
      // Expect 100 continue headers cause the last.fm server to not respond
      var baseURI = new Uri(BaseURL);
      ServicePointManager.Expect100Continue = false;
      var servicePoint = ServicePointManager.FindServicePoint(baseURI);
      servicePoint.Expect100Continue = false;

      LoadSettings();
    }

    #endregion

    #region settings

    private static void LoadSettings()
    {//TODO This should be in database
      using (var xmlreader = new MPSettings())
      {
        _theSK = xmlreader.GetValueAsString("lastfm:test", "SK", String.Empty);
      }
    }

    private static void SaveSettings()
    {//TODO This should be in database
      using (var xmlwriter = new MPSettings())
      {
        xmlwriter.SetValue("lastfm:test", "SK", _theSK);
      }
    }

    #endregion

    #region lastFM Authentication

    /// <summary>
    /// auth.getToken is the first part of the last.fm authentication process
    /// this returns a token that is valid for 60 mins.   The user needs to authorise
    /// access before we can obtain a session key (which is they valid forever)
    /// </summary>
    /// <returns></returns>
    public static string AuthGetToken()
    {
      var parms = new Dictionary<string, string>();
      const string methodName = "auth.getToken";
      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpGet(buildLastFMString);

      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
        return String.Empty;
      }

      var xDoc = XDocument.Parse(lastFMResponseXML);
      var token = String.Empty;
      foreach (var tokenElement in xDoc.Descendants("token"))
      {
        token = tokenElement.Value;
      }

      return token;
    }

    /// <summary>
    /// Not actually part of the last.fm API
    /// This returns the URL the user needs to visit to authorise access to their account by MP
    /// </summary>
    /// <param name="token">the token value generated by call to auth.getToken</param>
    /// <returns>The URL the user needs to visit</returns>
    public static string AuthGetAuthURL(string token)
    {
      // this is not actually a method in the last.fm API but a step needed for authorisation
      // first we call auth.getToken to get a token that lasts for 60 mins
      // then we need send user to the URL here
      // http://www.last.fm/api/auth/?api_key=xxxxxxxxxx&token=yyyyyy
      // they then need to sign into last.fm (if not already signed in) and authorise MP
      // once they have done that we can proceed to call auth.getSession
      // which provides a session key for user that is valid forever

      var parms = new Dictionary<string, string> {{"token", token}};
      var methodName = String.Empty;
      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, false);

      return "http://www.last.fm/api/auth/?" + buildLastFMString.TrimStart('&');
    }

    /// <summary>
    /// Final part of the authentication process
    /// Once token has been validated by the user (they have clicked the authorize
    /// button in web browser) we can get obtain a session key for that user that will
    /// be the value used to actually authenticate calls
    /// </summary>
    /// <param name="token">The token provided from the auth.getToken method</param>
    /// <returns></returns>
    public static string AuthGetSession(string token)
    {
      var parms = new Dictionary<string, string>();
      const string methodName = "auth.getSession";
      parms.Add("token", token);
      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpGet(buildLastFMString);

      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
        return String.Empty;
      }

      var lastFMXML = XDocument.Parse(lastFMResponseXML);

      var lfmElement = lastFMXML.Element("lfm");
      if (lfmElement != null)
      {
        var sessionElement = lfmElement.Element("session");
        if (sessionElement != null)
        {
          var userName = sessionElement.Element("name");
          var sk = sessionElement.Element("key");
          Log.Info("Saved last.fm session key for: {0}", userName);

          if (sk != null) _theSK = sk.Value;
          SaveSettings();

          return _theSK;
        }
      }

      Log.Error("AuthGetSession: Valid response but unexcepceted xml");
      Log.Error("{0}", lastFMResponseXML);

      return String.Empty;
    }

    #endregion

    #region scrobbling methods

    /// <summary>
    /// Announce track as now playing on user profile on last.fm website
    /// </summary>
    /// <param name="strArtist">artist of track being played</param>
    /// <param name="strTrack">name of track being played</param>
    /// <param name="strAlbum">album track being played is part of</param>
    /// <param name="strDuration">duration of track being played</param>
    public static void UpdateNowPlaying(String strArtist, String strTrack, String strAlbum, String strDuration)
    {
      if (string.IsNullOrEmpty(_theSK))
      {
        Log.Warn("Attempted to announce track: {0} - {1}", strArtist, strTrack);
        Log.Warn("But last.fm has not been authorised so aborting");
        return;
      }

      var parms = new Dictionary<string, string>();
      const string methodName = "track.updateNowPlaying";
      parms.Add("artist", strArtist);
      parms.Add("track", strTrack);
      if (!String.IsNullOrEmpty(strAlbum))
      {
        parms.Add("album", strAlbum);
      }
      if (!String.IsNullOrEmpty(strDuration))
      {
        parms.Add("duration", strDuration);
      }
      parms.Add("sk", _theSK);

      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpPost(buildLastFMString);
      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
      }
      else
      {
        Log.Info("Submitted last.fm now playing update for: {0} - {1}", strArtist, strTrack);
      }
    }

    /// <summary>
    /// Scrobble track to last.fm showing as played on user profile on last.fm website
    /// </summary>
    /// <param name="strArtist">artist of track that was played</param>
    /// <param name="strTrack">name of track that was played</param>
    /// <param name="strAlbum">album that track that was played is part of</param>
    public static void Scrobble(String strArtist, String strTrack, String strAlbum)
    {
      if(string.IsNullOrEmpty(_theSK))
      {
        Log.Warn("Attempted to scrobble track: {0} - {1}", strArtist, strTrack);
        Log.Warn("But last.fm has not been authorised so aborting");
        return;
      }

      //TODO: Need to handle offline scrobbling (save in cache and submit when internet connection is back)

      var span = (DateTime.UtcNow - new DateTime(1970, 1, 1));
      var unixEpoch = (int) span.TotalSeconds;

      var parms = new Dictionary<string, string>();
      const string methodName = "track.scrobble";
      parms.Add("timestamp", unixEpoch.ToString(CultureInfo.InvariantCulture));
      parms.Add("artist", strArtist);
      parms.Add("track", strTrack);
      if (!String.IsNullOrEmpty(strAlbum))
      {
        parms.Add("album", strAlbum);
      }
      parms.Add("sk", _theSK);

      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpPost(buildLastFMString);
      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
      }
      else
      {
        Log.Info("Submitted last.fm scobble for: {0} - {1}", strArtist, strTrack);
      }
    }

    #endregion

    #region radio methods

    /// <summary>
    /// Tune to a radio station.   After runing call GetRadioPlaylist to get the track listing
    /// </summary>
    /// <param name="strStationName"></param>
    public static void TuneRadio(string strStationName)
    {
      var parms = new Dictionary<string, string>();
      const string methodName = "radio.tune";
      parms.Add("station", strStationName);
      parms.Add("sk", _theSK);

      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpPost(buildLastFMString);
      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
      }
      else
      {
        Log.Info("Tuned to last.fm Radio Station: {0}", strStationName);
      }
    }

    /// <summary>
    /// Gets the playlist of radio station (will only be a small number of tracks)
    /// </summary>
    /// <returns>A list of tracks</returns>
    public static List<LastFMStreamingTrack> GetRadioPlaylist()
    {
      var parms = new Dictionary<string, string>();
      const string methodName = "radio.getPlaylist";
      parms.Add("bitrate", "128");
      parms.Add("sk", _theSK);

      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpPost(buildLastFMString);
      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
      }

      var y = XDocument.Parse(lastFMResponseXML);
      XNamespace ns = "http://xspf.org/ns/0/";
      var z = (from a in y.Descendants(ns + "track")
               select new LastFMStreamingTrack
                        {
                          ArtistName = a.Element(ns + "creator").Value,
                          TrackTitle = a.Element(ns + "title").Value,
                          TrackURL = a.Element(ns + "location").Value
                        }).ToList();
      return z;

    }

    #endregion

    #region track methods

    /// <summary>
    /// Get info about the track
    /// </summary>
    /// <param name="strArtist">Artist Name</param>
    /// <param name="strTrack">Track Title</param>
    public static void GetTrackInfo(string strArtist, string strTrack)
    {
      //TODO: what to return?
      var parms = new Dictionary<string, string>();
      const string methodName = "track.getInfo";
      parms.Add("artist", strArtist);
      parms.Add("track", strTrack);
      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpGet(buildLastFMString);

      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
      }

      var xDoc = XDocument.Parse(lastFMResponseXML);      
    }

    /// <summary>
    /// Pickup similar tracks to the details provided
    /// </summary>
    /// <param name="strTrack">name of track to use for lookup</param>
    /// <param name="strArtist">artist of track to use for lookup</param>
    public static List<LastFMTrack> GetSimilarTracks(string strTrack, string strArtist)
    {
      //build up a list of parameters to pass to last.fm API
      var parms = new Dictionary<string, string>();
      const string methodName = "track.getSimilar";
      parms.Add("track", strTrack);
      parms.Add("artist", strArtist);
      parms.Add("autocorrect", "1");
      //parms.Add("limit", _randomness.ToString(CultureInfo.InvariantCulture));

      //build URL string and call API
      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, false);
      var lastFMResponseXML = HttpGet(buildLastFMString);

      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
        return null;
      }

      //turn response into XML doc
      var lastFMXML = XDocument.Parse(lastFMResponseXML);

      //get a collection of tracks returned by last.fm API
      var tracks = (
                     from n in lastFMXML.Descendants("track")
                     let artistElement = n.Element("artist")
                     where artistElement != null
                     let trackElement = n.Element("name")
                     where trackElement != null
                     let artistNameElement = artistElement.Element("name")
                     where artistNameElement != null
                     select new LastFMTrack(
                       (string) artistNameElement.Value,
                       (string) trackElement.Value
                       )).ToList();

      return tracks;
    }

    /// <summary>
    /// Marks a track as loved on last.fm
    /// </summary>
    /// <param name="strArtist">Artist Name</param>
    /// <param name="strTrack">Track Title</param>
    /// <returns>True if successful</returns>
    public static bool LoveTrack(string strArtist, string strTrack)
    {
      var parms = new Dictionary<string, string>();
      const string methodName = "track.love";
      parms.Add("artist", strArtist);
      parms.Add("track", strTrack);
      parms.Add("sk", _theSK);

      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpPost(buildLastFMString);
      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
        return false;
      }
      else
      {
        Log.Info("Loved Track: {0} - {1}", strArtist, strTrack);
      }
      return true;
    }

    /// <summary>
    /// Unmarks a track as loved on last.fm
    /// </summary>
    /// <param name="strArtist">Artist Name</param>
    /// <param name="strTrack">Track Title</param>
    /// <returns>True if successful</returns>
    public static bool UnLoveTrack(string strArtist, string strTrack)
    {
      var parms = new Dictionary<string, string>();
      const string methodName = "track.unlove";
      parms.Add("artist", strArtist);
      parms.Add("track", strTrack);
      parms.Add("sk", _theSK);

      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpPost(buildLastFMString);
      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
        return false;
      }
      else
      {
        Log.Info("Unloved Track: {0} - {1}", strArtist, strTrack);
      }
      return true;
    }

    /// <summary>
    /// Marks track as banned on last.fm
    /// </summary>
    /// <param name="strArtist">Artist Name</param>
    /// <param name="strTrack">Track Title</param>
    /// <returns>True if successful</returns>
    public static bool BanTrack(string strArtist, string strTrack)
    {
      var parms = new Dictionary<string, string>();
      const string methodName = "track.ban";
      parms.Add("artist", strArtist);
      parms.Add("track", strTrack);
      parms.Add("sk", _theSK);

      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpPost(buildLastFMString);
      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
        return false;
      }
      else
      {
        Log.Info("Banned Track: {0} - {1}", strArtist, strTrack);
      }
      return true;
    }

    /// <summary>
    /// Unmarks a track as banned on last.fm
    /// </summary>
    /// <param name="strArtist">Artist Name</param>
    /// <param name="strTrack">Track Title</param>
    /// <returns>True if successful</returns>
    public static bool UnBanTrack(string strArtist, string strTrack)
    {
      var parms = new Dictionary<string, string>();
      const string methodName = "track.unban";
      parms.Add("artist", strArtist);
      parms.Add("track", strTrack);
      parms.Add("sk", _theSK);

      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpPost(buildLastFMString);
      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
        return false;
      }
      else
      {
        Log.Info("Unbanned Track: {0} - {1}", strArtist, strTrack);
      }
      return true;
    }

    #endregion

    #region artist methods

    /// <summary>
    /// Get artist details from last.fm
    /// </summary>
    /// <param name="strArtist">Artist Name</param>
    public static void GetArtistInfo(string strArtist)
    {
      //TODO: what to return?
      var parms = new Dictionary<string, string>();
      const string methodName = "artist.getInfo";
      parms.Add("artist", strArtist);
      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpGet(buildLastFMString);

      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
      }

      var xDoc = XDocument.Parse(lastFMResponseXML);
    }

    #endregion

    #region album methods

    /// <summary>
    /// Get album details
    /// </summary>
    /// <param name="strArtist">Artist Naae</param>
    /// <param name="strAlbum">Album Name</param>
    public static void GetAlbumInfo(string strArtist, string strAlbum)
    {
      //TODO: what to return?
      var parms = new Dictionary<string, string>();
      const string methodName = "album.getInfo";
      parms.Add("artist", strArtist);
      parms.Add("album", strAlbum);
      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpGet(buildLastFMString);

      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
      }

      var xDoc = XDocument.Parse(lastFMResponseXML);
    }
    
    #endregion

    #region user methods

    /// <summary>
    /// Get details of authenticated user
    /// </summary>
    public static void GetUserInfo()
    {
      //TODO: consider return value
      GetUserInfo(String.Empty);
    }

    /// <summary>
    /// Get details of named user
    /// </summary>
    /// <param name="strUser">Name of user</param>
    public static void GetUserInfo(string strUser)
    {
      var parms = new Dictionary<string, string>();
      const string methodName = "user.getInfo";
      if(!String.IsNullOrEmpty(strUser))
      {
        parms.Add("user", strUser);
      }
      var buildLastFMString = LastFMHelper.LastFMHelper.BuildLastFMString(parms, methodName, true);

      var lastFMResponseXML = HttpGet(buildLastFMString);

      if (!IsValidReponse(lastFMResponseXML))
      {
        Log.Error("Invalid Response from last.fm request");
        Log.Error("{0}", lastFMResponseXML);
      }

      var xDoc = XDocument.Parse(lastFMResponseXML);
    }

    #endregion

    #region HTTP methods

    /// <summary>
    /// Calls the last.fm API using a HTTP GET call
    /// </summary>
    /// <param name="querystring">querystring to pass to server</param>
    /// <returns>Text response from server</returns>
    private static string HttpGet(string querystring)
    {
      // TODO this should be replaced with a simple call to XDocument.Load (only for GET calls)
      //TODO: need to add check for no internet connection?
      var lastFMResponse = String.Empty;
      var myWebClient = new WebClient();
      try
      {
        var st = myWebClient.OpenRead(BaseURL + "?" + querystring);
        if (st != null)
        {
          var sr = new StreamReader(st);
          lastFMResponse = sr.ReadToEnd();
        }
      }
      catch (WebException ex)
      {
        // last.fm returns a HTTP error if not successful but still returns a response with details of the error.
        var res = (HttpWebResponse)ex.Response;
        var st = res.GetResponseStream();
        if (st != null)
        {
          var reader = new StreamReader(st);
          var ttt = reader.ReadToEnd();
          lastFMResponse = ttt;
        }
      }
      catch (Exception ex)
      {
        Log.Error(ex);
      }
      finally
      {
        myWebClient.Dispose();
      }

#if DEBUG
      Log.Info(lastFMResponse);
#endif

      return lastFMResponse;
    }

    /// <summary>
    /// Calls the last.fm API using a HTTP POST call
    /// </summary>
    /// <param name="postData">data to be sent to server</param>
    /// <returns>Text response from server</returns>
    private static string HttpPost(string postData)
    {
      //TODO: need to add check for no internet connection?
      var lastFMResponse = String.Empty;
      var postArray = Encoding.ASCII.GetBytes(postData);
      using(var myWebClient = new WebClient())
      {
        try
        {
          myWebClient.Headers.Add("Content-Type", "application/x-www-form-urlencoded");
          var responseArray = myWebClient.UploadData(BaseURL, postArray);
          lastFMResponse = Encoding.ASCII.GetString(responseArray);
        }
        catch (WebException ex)
        {
          //last.fm API returns a HTTP error is not successful but still returns a response
          var res = (HttpWebResponse) ex.Response;
          var st = res.GetResponseStream();
          if (st != null)
          {
            var reader = new StreamReader(st);
            var ttt = reader.ReadToEnd();
            lastFMResponse = ttt;
          }
        }
        catch (Exception ex)
        {
          Log.Error(ex);
        }
      }

#if DEBUG
      Log.Info(lastFMResponse);
#endif
      //TODO should return XDocument rather than string ???
      return lastFMResponse;
    }

    /// <summary>
    /// Checks that the response from last.fm is valid and contains data
    /// </summary>
    /// <param name="lastFMResponse">xml returned from last.fm API call</param>
    /// <returns>Whether response includes a status="ok" element</returns>
    public static bool IsValidReponse(String lastFMResponse)
    {//TODO this should use XML to Linq
      return lastFMResponse.Contains("<lfm status=\"ok\">");
    }

    #endregion

    #region

    /// <summary>
    /// Takes a list of tracks supplied by last.fm and matches these to tracks in the database
    /// </summary>
    /// <param name="tracks"></param>
    /// <returns>List of matched songs from input that exist in the users database</returns>
    public static List<Song> GetSimilarTracksInDatabase(List<LastFMTrack> tracks)
    {
      // list contains songs which exist in users collection
      var dbTrackListing = new List<Song>();

      //identify which are available in users collection (ie. we can use they for auto DJ mode)
      foreach (var strSQL in tracks.Select(track => string.Format("select * from tracks where strartist like '%| {0} |%' and strTitle = '{1}'",
                                                                  DatabaseUtility.RemoveInvalidChars(track.ArtistName),
                                                                  DatabaseUtility.RemoveInvalidChars(track.TrackTitle))))
      {
        List<Song> trackListing;
        MusicDatabase.Instance.GetSongsByFilter(strSQL, out trackListing, "tracks");
        
        dbTrackListing.AddRange(trackListing);
      }

      return dbTrackListing;
    }

    #endregion
  }
}
